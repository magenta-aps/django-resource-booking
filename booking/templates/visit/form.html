{% extends 'index.html' %}
{% load i18n %}
{% load staticfiles %}
{% load booking_tags %}

{% block head %}
    <link rel="stylesheet" href="{% static 'thirdparty/bootstrap-datetime-picker/css/bootstrap-datetimepicker.min.css' %}"/>
{% endblock %}

{% block content %}

    <div class="container">
        <h1>{% if object %}{% trans "Rediger tilbud" %}{% else %}{% trans "Nyt tilbud" %}{% endif %}</h1>
        <hr/>
        <form action="" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            {{ form.non_field_errors }}

            <fieldset>
                {{ form.title.errors }}
                <label for="{{ form.title.id_for_label }}">{{ form.title.label }}:</label>
                {{ form.title }}
            </fieldset>

            <div id="accordion" class="panel-group" aria-multiselectable="true" role="tablist">

                <div class="panel panel-default">
                    <div id="headingDescription" class="panel-heading" role="tab">
                        <h4 class="panel-title">
                            <a aria-controls="collapseDescription" aria-expanded="true" href="#collapseDescription" data-parent="#accordion" data-toggle="collapse" role="button">{% trans "Beskrivelse" %}</a>
                        </h4>
                    </div>
                    <div id="collapseDescription" class="panel-collapse collapse
                    {% if not form.errors or form.teaser.errors or form.description.errors or form.price.errors %}in{% endif %}
                    " aria-labelledby="headingDescription" role="tabpanel">
                        <div class="panel-body">
                            <fieldset>
                                {{ form.teaser.errors }}
                                <label for="{{ form.teaser.id_for_label }}">{{ form.teaser.label }}:</label>
                                {{ form.teaser }}
                            </fieldset>
                            <fieldset>
                                {{ form.description.errors }}
                                <label for="{{ form.description.id_for_label }}">{{ form.description.label }}:</label>
                                {{ form.description }}
                            </fieldset>
                            <fieldset>
                                {{ form.price.errors }}
                                <label for="{{ form.price.id_for_label }}">{{ form.price.label }}:</label>
                                {{ form.price }}
                            </fieldset>
                        </div>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div id="headingCategory" class="panel-heading" role="tab">
                        <h4 class="panel-title">
                            <a class="" aria-controls="collapseCategory" aria-expanded="true" href="#collapseCategory" data-parent="#accordion" data-toggle="collapse" role="button">{% trans "Kategorisering" %}</a>
                        </h4>
                    </div>
                    <div id="collapseCategory" class="panel-collapse collapse
                    {% if form.type.errors or form.tags.errors %}in{% endif %}
                    " aria-labelledby="headingCategory" role="tabpanel" aria-expanded="true" style="">
                        <div class="panel-body">
                            <fieldset>
                                {{ form.type.errors }}
                                <label for="{{ form.type.id_for_label }}">{{ form.type.label }}:</label>
                                {{ form.type }}
                            </fieldset>
                            <fieldset>
                                {{ form.tags.errors }}
                                <label for="{{ form.tags.id_for_label }}">{{ form.tags.label }}:</label>
                                {{ form.tags }}
                            </fieldset>
                        </div>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div id="headingAudience" class="panel-heading" role="tab">
                        <h4 class="panel-title">
                            <a class="" aria-controls="collapseAudience" aria-expanded="true" href="#collapseAudience" data-parent="#accordion" data-toggle="collapse" role="button">{% trans "Målgruppe" %}</a>
                        </h4>
                    </div>
                    <div id="collapseAudience" class="panel-collapse collapse
                        {% if form.institution_level.errors or form.topics.errors or form.level.errors or form.class_level_min.errors or form.class_level_max.errors or form.minimum_number_of_visitors.errors or form.maximum_number_of_visitors.errors %}in{% endif %}
                        " aria-labelledby="headingAudience" role="tabpanel" aria-expanded="true" style="">
                        <div class="panel-body">

                            <fieldset>
                                {{ form.institution_level.errors }}
                                <label for="{{ form.institution_level.id_for_label }}">{{ form.institution_level.label }}:</label>
                                {{ form.institution_level }}
                            </fieldset>
                            <fieldset>
                                {{ form.topics.errors }}
                                <label for="{{ form.topics.id_for_label }}">{{ form.topics.label }}:</label>
                                {{ form.topics }}
                            </fieldset>

                            <div class="institution_level_dependent" data-display-value="1">
                                <fieldset>
                                    {{ form.level.errors }}
                                    <label for="{{ form.level.id_for_label }}">{{ form.level.label }}:</label>
                                    {{ form.level }}
                                </fieldset>
                            </div>
                            <div class="institution_level_dependent" data-display-value="0">
                                <fieldset>
                                    {{ form.class_level_min.errors }}
                                    <label for="{{ form.class_level_min.id_for_label }}">{{ form.class_level_min.label }}:</label>
                                    {{ form.class_level_min }}
                                </fieldset>
                                <fieldset>
                                    {{ form.class_level_max.errors }}
                                    <label for="{{ form.class_level_max.id_for_label }}">{{ form.class_level_max.label }}:</label>
                                    {{ form.class_level_max }}
                                </fieldset>
                            </div>
                            <fieldset>
                                {{ form.minimum_number_of_visitors.errors }}
                                <label for="{{ form.minimum_number_of_visitors.id_for_label }}">{{ form.minimum_number_of_visitors.label }}:</label>
                                {{ form.minimum_number_of_visitors }}
                            </fieldset>
                            <fieldset>
                                {{ form.maximum_number_of_visitors.errors }}
                                <label for="{{ form.maximum_number_of_visitors.id_for_label }}">{{ form.maximum_number_of_visitors.label }}:</label>
                                {{ form.maximum_number_of_visitors }}
                            </fieldset>
                        </div>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div id="headingTimePlace" class="panel-heading" role="tab">
                        <h4 class="panel-title">
                            <a class="" aria-controls="collapseTimePlace" aria-expanded="true" href="#collapseTimePlace" data-parent="#accordion" data-toggle="collapse" role="button">{% trans "Tid og sted" %}</a>
                        </h4>
                    </div>
                    <div id="collapseTimePlace" class="panel-collapse collapse
                    {% if form.time.errors or form.duration.errors or form.locality.errors or form.room.errors %}in{% endif %}
                    " aria-labelledby="headingTimePlace" role="tabpanel" aria-expanded="true" style="">
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-sm-12 col-md-6">
                                    <fieldset>
                                        {{ form.time.errors }}
                                        <label for="{{ form.time.id_for_label }}">{{ form.time.label }}:</label>
                                        {{ form.time }}
                                    </fieldset>
                                    <fieldset>
                                        {{ form.duration.errors }}
                                        <label for="{{ form.duration.id_for_label }}">{{ form.duration.label }}:</label>
                                        <div class="form-inline duration">
                                        {{ form.duration }}
                                        </div>
                                    </fieldset>
                                </div>
                                <div class="col-sm-12 col-md-6">
                                    <fieldset>
                                        {{ form.locality.errors }}
                                        <label for="{{ form.locality.id_for_label }}">{{ form.locality.label }}:</label>
                                        {{ form.locality }}
                                    </fieldset>
                                    <fieldset>
                                        {{ form.room.errors }}
                                        <label for="{{ form.room.id_for_label }}">{{ form.room.label }}:</label>
                                        {{ form.room }}
                                    </fieldset>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div id="headingContact" class="panel-heading" role="tab">
                        <h4 class="panel-title">
                            <a class="" aria-controls="collapseContact" aria-expanded="true" href="#collapseContact" data-parent="#accordion" data-toggle="collapse" role="button">{% trans "Kontaktinformation" %}</a>
                        </h4>
                    </div>
                    <div id="collapseContact" class="panel-collapse collapse
                    {% if form.enabled.errors or form.contact_persons.errors %}in{% endif %}
                    " aria-labelledby="headingContact" role="tabpanel" aria-expanded="true" style="">
                        <div class="panel-body">
                            <fieldset>
                                {{ form.unit.errors }}
                                <label for="{{ form.unit.id_for_label }}">{{ form.unit.label }}:</label>
                                {{ form.unit }}
                            </fieldset>
                            <fieldset>
                                {{ form.enabled.errors }}
                                <label class="radiolabel">
                                    <label for="{{ form.enabled.id_for_label }}">{{ form.enabled }} Kan bookes</label>
                                </label>
                            </fieldset>
                            <fieldset>
                                {{ form.contact_persons.errors }}
                                <label for="{{ form.contact_persons.id_for_label }}">{{ form.contact_persons.label }}:</label>
                                {{ form.contact_persons }}
                            </fieldset>
                        </div>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div id="headingAttach" class="panel-heading" role="tab">
                        <h4 class="panel-title">
                            <a class="" aria-controls="collapseAttach" aria-expanded="true" href="#collapseAttach" data-parent="#accordion" data-toggle="collapse" role="button">{% trans "Vedhæftninger" %}</a>
                        </h4>
                    </div>
                    <div id="collapseAttach" class="panel-collapse collapse" aria-labelledby="headingAttach" role="tabpanel" aria-expanded="true" style="">
                        <div class="panel-body">
                            <fieldset>
                                <label>{% trans "Vedhæftede filer" %}:</label>
                                <ul>
                                {% for material in fileformset.studymaterials %}
                                    <li>
                                        <a href="{{ MEDIA_URL }}{{ material.file.url }}">{{ material.file.name | upload_name_strip_path }}</a>
                                    </li>
                                {% endfor %}
                                </ul>
                                {{ fileformset.management_form }}
                                <div id="attachFileFields">
                                {% for fileform in fileformset %}
                                    {{ fileform.file }}
                                {% endfor %}
                                </div>
                                <a id="attachAddFileField">{% trans "Tilføj ny fil" %}</a>
                            </fieldset>
                        </div>
                    </div>
                </div>
            </div>

            {% include 'common/save_cancel.html' %}
        </form>
        <footer>
        </footer>
    </div>

{% endblock %}

{% block extra_scripts %}
    <script type="text/javascript" src="{% static 'thirdparty/bootstrap-datetime-picker/js/bootstrap-datetimepicker.min.js' %}"></script>
    <script type="text/javascript"><!--
        $(function(){
            var totalFormsField = $("#{{ fileformset.management_form.TOTAL_FORMS.id_for_label }}"),
                maxForms = parseInt($("#{{ fileformset.management_form.MAX_NUM_FORMS.id_for_label }}").val()) || 1000,
                fieldContainer = $("#attachFileFields"),
                numberFinder = /\d+/;

            $("#attachAddFileField").click(function(){
                if (fieldContainer.find("input[type=file]").length < maxForms) {
                    var newFileField = fieldContainer.find("input[type=file]").last().clone();
                    var match = numberFinder.exec(newFileField.attr("id"));
                    if (match) {
                        var number = parseInt(match[0], 10) + 1;
                        newFileField.attr("id", newFileField.attr("id").replace(numberFinder, number));
                        newFileField.attr("name", newFileField.attr("name").replace(numberFinder, number));
                        newFileField.val(null);
                        fieldContainer.append(newFileField);
                        totalFormsField.val(fieldContainer.find("input[type=file]").length);
                    }
                }
            });
        });

        $(function(){
            // See doc at http://www.malot.fr/bootstrap-datetimepicker/
            $("#{{ form.time.id_for_label }}").datetimepicker({
                locale: 'da',
                autoclose: true
            });
        });

        $(function(){
            var select = $("#{{ form.institution_level.id_for_label }}");
            var changeDisplay = function(){
                var value = select.val();
                $(".institution_level_dependent[data-display-value='"+value+"']").show();
                $(".institution_level_dependent[data-display-value!='"+value+"']").hide();
            };
            select.change(changeDisplay);
            changeDisplay();
        });
    //--></script>
{% endblock %}

